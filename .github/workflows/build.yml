name: Build Solfeggio Plugin

on:
  push:
    branches: [main, develop]
    tags: ['v*']
  pull_request:
    branches: [main]

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            name: Linux
            cmake_args: ""
          - os: macos-latest
            name: macOS
            cmake_args: "-DCMAKE_OSX_ARCHITECTURES=arm64 -DCODESIGN_IDENTITY=-"
          - os: windows-latest
            name: Windows
            cmake_args: ""

    runs-on: ${{ matrix.os }}
    name: Build (${{ matrix.name }})

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Linux dependencies
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update -q
          sudo apt-get install -y \
            libasound2-dev libjack-jackd2-dev libx11-dev \
            libxrandr-dev libxinerama-dev libxcursor-dev \
            libfreetype-dev libwebkit2gtk-4.1-dev libgtk-3-dev \
            libcurl4-openssl-dev pkg-config ccache

      - name: Install ccache (macOS)
        if: runner.os == 'macOS'
        run: brew install ccache

      - name: Cache JUCE source
        uses: actions/cache@v4
        with:
          path: build/_deps
          key: juce-8.0.6-${{ runner.os }}-${{ hashFiles('CMakeLists.txt') }}
          restore-keys: juce-8.0.6-${{ runner.os }}-

      - name: Cache compiler objects
        uses: actions/cache@v4
        with:
          path: ~/.ccache
          key: ccache-${{ runner.os }}-${{ github.sha }}
          restore-keys: ccache-${{ runner.os }}-

      - name: Configure CMake
        run: cmake -B build -DCMAKE_BUILD_TYPE=Release ${{ matrix.cmake_args }}

      - name: Build
        run: cmake --build build --config Release --parallel

      # -----------------------------------------------------------------------
      # Stage final output files into a clean dist/ folder so artifact zips
      # have a flat, user-friendly structure instead of deep build paths.
      # -----------------------------------------------------------------------
      - name: Stage artifacts (Linux)
        if: runner.os == 'Linux'
        run: |
          mkdir -p dist/VST3 dist/Standalone
          find build -name "*.vst3" -type d -exec cp -r {} dist/VST3/ \;
          find build -path "*/Standalone/Solfeggio*" ! -name "*.so" -exec cp -r {} dist/Standalone/ \; || true
          ls -R dist/

      - name: Stage artifacts (macOS)
        if: runner.os == 'macOS'
        run: |
          mkdir -p dist/VST3 dist/AU
          find build -name "*.vst3" -type d -exec cp -r {} dist/VST3/ \;
          find build -name "*.component" -type d -exec cp -r {} dist/AU/ \; || true
          ls -R dist/

      - name: Stage artifacts (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path dist\VST3, dist\Standalone | Out-Null
          
          # Copy VST3 bundle (use direct path to avoid scanning huge build dir)
          $vst3Source = "build\SolfeggioPlugin_artefacts\Release\VST3\Solfeggio Frequencies.vst3"
          if (Test-Path $vst3Source) {
            $vst3Target = "dist\VST3\Solfeggio Frequencies.vst3"
            New-Item -ItemType Directory -Force -Path $vst3Target | Out-Null
            Copy-Item -Path "$vst3Source\*" -Destination $vst3Target -Recurse -Force -Exclude "desktop.ini"
          }
          
          # Copy Standalone executables and icons
          $standaloneSource = "build\SolfeggioPlugin_artefacts\Release\Standalone"
          if (Test-Path $standaloneSource) {
            Get-ChildItem $standaloneSource -File | 
              Where-Object { $_.Extension -eq ".exe" -or $_.Extension -eq ".ico" } |
              ForEach-Object { Copy-Item -Force $_.FullName -Destination dist\Standalone\ }
          }
          
          Get-ChildItem dist -Recurse

      - name: Install NSIS (Windows, tags only)
        if: runner.os == 'Windows' && startsWith(github.ref, 'refs/tags/')
        run: choco install nsis --no-progress -y

      - name: Package installer (Windows NSIS)
        if: runner.os == 'Windows' && startsWith(github.ref, 'refs/tags/')
        continue-on-error: true
        shell: pwsh
        run: |
          Set-Location build
          cpack -G NSIS
          # Move installer to dist/ with a proper name
          $exe = Get-ChildItem -Filter "*.exe" | Select-Object -First 1
          if ($exe) {
            Copy-Item $exe.FullName "..\dist\SolfeggioFrequencies-${{ github.ref_name }}-Windows-Setup.exe"
          }

      - name: Package installer (macOS DMG)
        if: runner.os == 'macOS' && startsWith(github.ref, 'refs/tags/')
        continue-on-error: true
        run: |
          cd build && cpack -G DragNDrop
          dmg=$(find . -name "*.dmg" | head -1)
          if [ -n "$dmg" ]; then
            cp "$dmg" "../dist/SolfeggioFrequencies-${{ github.ref_name }}-macOS.dmg"
          fi

      - name: Upload VST3 artifact
        uses: actions/upload-artifact@v4
        with:
          name: SolfeggioPlugin-${{ matrix.name }}-VST3
          path: dist/VST3/
          if-no-files-found: warn

      - name: Upload Standalone artifact
        uses: actions/upload-artifact@v4
        with:
          name: SolfeggioPlugin-${{ matrix.name }}-Standalone
          path: dist/Standalone/
          if-no-files-found: warn

      - name: Upload installer artifact
        if: startsWith(github.ref, 'refs/tags/')
        uses: actions/upload-artifact@v4
        with:
          name: SolfeggioPlugin-${{ matrix.name }}-Installer
          path: |
            dist/*.exe
            dist/*.dmg
          if-no-files-found: warn

  release:
    needs: build
    if: always() && startsWith(github.ref, 'refs/tags/')
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
        continue-on-error: true

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: "Solfeggio Frequencies ${{ github.ref_name }}"
          body: |
            ### What are "Energetic" Frequencies (Solfeggio)?

            The most commonly mentioned frequencies are the Solfeggio Frequencies, a scale of specific tones that dates back to Gregorian chants and sacred traditions. The main ones are:

            | Frequency | Popular Name | Attributed Benefits |
            | ---------- | ---------------------- | ---------------------------------------------------------- |
            | **174 Hz** | Analgesic Frequency | Relief of physical and emotional pain, feeling of security |
            | **285 Hz** | Healing Frequency | Tissue stimulation, energy restoration |
            | **396 Hz** | Fear Release | Eliminates guilt and subconscious fears |
            | **417 Hz** | Frequency of Change | Facilitates positive changes, energetic cleansing |
            | **432 Hz** | Nature Frequency | Deep relaxation, connection with natural rhythms |
            | **528 Hz** | Frequency of Love/DNA | Cellular repair, stress reduction, emotional upliftment |
            | **639 Hz** | Connection Frequency | Harmonizes relationships, empathy |
            | **741 Hz** | Detox Frequency | Problem solving, body cleansing |
            | **852 Hz** | Spiritual Frequency | Awakening of intuition, connection with the "higher self" |


            ### What Science Really Says

            Proven Evidence:
            - A 2018 Japanese study showed that 528 Hz significantly reduces cortisol (the stress hormone) and increases oxytocin (the happiness hormone) after just 5 minutes of listening.
            - Italian research demonstrated that 432 Hz decreases heart rate compared to the standard 440 Hz.
            - Glen Rein's experiment (1988) showed that Gregorian and Sanskrit chants increased UV light absorption by DNA by 5-9%, while rock music decreased it.
            - A study with zebrafish (2023) showed that exposure to Solfeggio frequencies reversed cognitive deficits caused by stress.


            ### Scientific Caution:

            The scientific community still considers that many of these claims lack rigorous controlled studies and significant samples. The exact mechanisms of how these frequencies affect the body are not yet fully understood.


            ![Solfeggio Frequencies UI](https://raw.githubusercontent.com/WalissonRodrigo/SolfeggioProcessor/main/Resources/example-ui-v1.png)
          files: |
            artifacts/SolfeggioPlugin-Windows-Installer/*.exe
            artifacts/SolfeggioPlugin-macOS-Installer/*.dmg
            artifacts/SolfeggioPlugin-Linux-VST3/**
            artifacts/SolfeggioPlugin-Windows-VST3/**
            artifacts/SolfeggioPlugin-macOS-VST3/**
            artifacts/SolfeggioPlugin-Linux-Standalone/**
          draft: false
          prerelease: false
          generate_release_notes: true
          fail_on_unmatched_files: false
